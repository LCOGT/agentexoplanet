{% extends 'agentex/base.html' %}

{% block body-class %}full agentex dossier {%endblock%}

{%block header %}Transit Lightcurve of {{event.title}}{%endblock%}

{% block script-content %}
	<!--[if lt IE 9]><script language="javascript" type="text/javascript" src="{{ MEDIA_URL }}js/excanvas.js"></script><![endif]-->
	<script language="javascript" type="text/javascript" src="{{ MEDIA_URL }}js/jquery.min.js"></script>
	<script language="javascript" type="text/javascript" src="{{ MEDIA_URL }}js/sylvester-min.js"></script>
	<script language="javascript" type="text/javascript" src="{{ MEDIA_URL }}js/optimize.js"></script>
	<script language="javascript" type="text/javascript" src="{{ MEDIA_URL }}js/jquery.graph.js"></script>
	<script language="javascript" type="text/javascript" src="{{ MEDIA_URL }}js/lightcurve.js"></script>
	<script language="javascript" type="text/javascript" src="{{ MEDIA_URL }}js/raphael.js"></script>

	<script type="text/javascript">
	<!--
	var helper = true;
	var nscroll = 1;
	$(document).ready(function(){
		$('#nextstep').addClass('fancybtndisable');

	{% if numsuper %}
		html = '<p>Measurements with {{numsuper}} calibrator{% if numsuper > 1 %}s were combined{%else%} was used{%endif%} to make this final lightcurve. With more calibrators the lightcurve should improve.'
//		html += '<div id="mainplot" style="padding-left:40px;height:450px;width:880px;"><\/div>';
		html += '<div id="mainplot" style="height:448px;width:100%;"><\/div>';
	
	{% endif %}		
		addHelpHint($('#mainplot'),'This graph shows how the relative brightness of the host star changes as exoplanet <a href="{% url agentex.views.infoview event.name %}" class="objectspecific">{{event.title}}<\/a> passes in front of it.<br/><br/> This graph combines the measurements and classifications from all citizen scientists on this project, into one supercalibrator result.');
		addHelpHint($('#mylink'),'View your measurements as <a href="{% url agentex.views.briefing %}#lightcurve">lightcurves<\/a>','left');
		addHelpHint($('#avlink'),'Classify your measurements','left');
		addHelpHint($('#sulink'),'This is the page you are looking at.','left');

	{% if numsuper %}
	
		$('.breadcrumb').after(html);

		if($('table#datatable').length > 0){
			$('table#datatable').before('<div id="tabletoggle" style="float:left;cursor:pointer;"><img src="{{MEDIA_URL}}images/table_icon&24.png" alt="toggle table" title="Show or hide the data table" style="width:16px;margin-right:0px;" \/> toggle data table<\/div><br style="clear:both;" />')
			$('#tabletoggle').bind('click',function(){
				$('table.accessible').toggle();
			})
		}

		markings = [
			{ color: '#f6f6f6', yaxis: { from: 8 } },
			{ color: '#606060', lineWidth: 1, yaxis: { from: 1, to: 1 } },
			{ color: '#000', lineWidth: 1, xaxis: { from: 8, to: 8 } }
		];
	
		lcurve = new Lightcurve({
			id:'#mainplot',
			msg:{
				nodata: "<h3>You have no data points yet<\/h3><p>Why not make some <a href='{% url agentex.views.addvalue event.name %}'>measurements of {{event.title}}<\/a><\/p>",
				login: "Please <a href='{% url django.contrib.auth.views.login %}'>login<\/a> to edit"
			},
			data:{{data|safe}},
			authenticated: {% if user.is_authenticated %}true{% else %}false{% endif %},
			type: "super",
			options: {
					series: { points: { show: false } },
					grid: { hoverable: false, clickable: false, markings:markings },
					selection: { mode: "xy", color: '#000000' }
			},
			period: {{ target.period }}*86400000
		});
	
	
		var svg;
		var svg2;
	
		// Constants
		var au = 1.496e11;
		var G = 6.67e-11;
		var wide = $('#mainplotholder').outerWidth();
		var tall = Math.round((wide/3)/16)*16;
	
		// Scaling
		var metres2px = 0;
		var au_px = 0;
	
		// Define some planetary system objects
		var sun = { radius: 1392000000, mass: 1.9891e30, svg:'', x:0,y:0 };
		var jupiter = { radius: 71492000, mass: 1.8986e27, svg:'', x:0,y:0 };
		var star = { radius: 0, mass: {{ target.mass }}*1.9891e30, svg:'', x:0,y:0 };
		var planet = { radius: 0, a: 0, period: {{ target.period }}*86400, svg:'', x:0,y:0 };
		var marker = { a: 0.01*au, svg:'' };
		var label = { a: 0.01*au, svg:'' };
	
		var orbiting = false;
	
		function defineMarker(a){
			a = au*Math.floor(100*a/au)/100;
			marker.a = a;
			label.a = a;
		}
	
	
		lcurve.mainplot.bind("mousedown", function (event) {
			// axis coordinates for other axes, if present, are in pos.x2, pos.x3, ...
			// if you need global screen coordinates, they are pos.pageX, pos.pageY
		});
		
		lcurve.mainplot.bind("plotselected",function(event, ranges){
			makeOrbit(ranges);
		}).bind("plotunselected",function(event, ranges){
			stop();
		}).bind("click",function(event){
		});

		makeOrbit(lcurve.fitted)

		// Input: ranges = {xaxis: { from: a, to: b }, yaxis: { from: a, to: b }}
		function makeOrbit(ranges){
			t_trans = Math.abs(ranges.xaxis.to-ranges.xaxis.from)/1000;	// Transit length in seconds
			dip = Math.abs(ranges.yaxis.to-ranges.yaxis.from);	// Depth of dip
			if(dip > 0){
				$('#relativesizes').show();
				planet.a = Math.pow(((planet.period*planet.period*star.mass*G)/(4*Math.PI*Math.PI)),1/3);
	
				defineMarker(planet.a);
				
				metres2px = (wide*0.45)/planet.a;
				au_px = au*metres2px;
				
				star.radius = planet.a*(t_trans*Math.PI)/planet.period;
				planet.radius = Math.sqrt(dip)*star.radius;
	
				star.x = wide/2;
				star.y = tall/2;
				planet.y = star.y;
	
				r_p_scaled = (planet.radius/star.radius)*(t_trans*planet.a*Math.PI/planet.period);
		
				if(typeof svg=="undefined"){
					svg = Raphael("planetillustration", wide, tall);
					line = svg.path("M0 "+star.y+"L"+wide+" "+star.y).attr({stroke:'#000000',"stroke-width": 1,"stroke-dasharray":["--"],"stroke-opacity": 0.7});
					marker.svg = svg.path("M"+(star.x+marker.a*metres2px)+" "+(star.y-5)+"L"+(star.x+marker.a*metres2px)+" "+(star.y+5)).attr({stroke:'#000000',"stroke-width": 1,"stroke-opacity": 0.7});
					label.svg = svg.text((star.x+label.a*metres2px),(star.y+15),(label.a/au).toFixed(2)+' AU');
					star.svg = svg.circle(star.x,star.y,star.radius*metres2px).attr({fill: 'r#ffdd00-#ddbb00',stroke: '#bb9900',"stroke-width": 2,"stroke-dasharray":["--"],"fill-opacity": 0.95});
					planet.svg = svg.circle(star.x-planet.a*metres2px,planet.y,planet.radius*metres2px).attr({fill: '#444444',stroke:'#000000',"stroke-width": 2,"stroke-dasharray":["-"],"fill-opacity": 0.95});
					orbit();
					
				}else{
					if(!orbiting){
						star.svg.attr({cx:star.x,cy:star.y});
						planet.svg.attr({cx:star.x-(planet.a*metres2px),cy:planet.y});
						planet.svg.toFront()
						orbit();
					}
					star.svg.animate({r: (star.radius*metres2px)},500);
					planet.svg.animate({r: (planet.radius*metres2px)},500);
					marker.svg.animate({x: star.x+(marker.a*metres2px)},500);
					label.svg.animate({x: star.x+(label.a*metres2px)},500);
				}
				
				$('#planetdetails').html('<table><tr><th>Property<\/th><th>Value<\/th><th>Note<\/th><\/tr><tr><td>Star mass<\/td><td>'+(star.mass/sun.mass).toFixed(2)+' solar<\/td><td>inferred<\/td><\/tr><tr><td>Orbital period<\/td><td>'+(planet.period/86400).toFixed(3)+' days<\/td><td>measured<\/td><\/tr><tr><td>Orbital radius<\/td><td>'+(Math.round(planet.a/1000000)*1000)+' km<br/>'+(planet.a/1.49e11).toFixed(3)+' AU<\/td><td>inferred<\/td><\/tr><tr class="success"><td>Duration of transit<\/td><td>'+(t_trans/86400).toFixed(3)+' days<\/td><td>using your final lightcurve<\/td><\/tr><tr class="success"><td>Dip in brightness<\/td><td>'+(dip).toFixed(3)+'<\/td><td>using your final lightcurve<\/td><\/tr><tr class="success"><td>Ratio of planet to star radius<\/td><td>'+(planet.radius/star.radius).toFixed(2)+'<\/td><td>calculated from your final lightcurve<\/td><\/tr><tr><td>Planet\'s radius<\/td><td>'+(Math.round(planet.radius/100000)*100)+' km<br />'+(planet.radius/jupiter.radius).toFixed(2)+' R<sub>Jupiter<\/sub><\/td><td>inferred (compare this to <a href="http://exoplanet.hanno-rein.de/system.php?id={{target.name}}\+b">values obtained from other experiments<\/a>)<\/td><\/tr><\/table>')
				$('.transitperiod').html(({{ target.period }}).toFixed(3)+" days");
				$('.transitlength').html((t_trans/3600).toFixed(3)+" hours");
				$('.transitdip').html((dip*100).toFixed(2)+"%");
				$('.transitscale').html((planet.radius/star.radius).toFixed(2));
				$('.transitorbit').html((Math.round(planet.a/1000000)*1000)+" km");
				$('.transitorbitau').html((planet.a/au).toFixed(3)+" AU");
				$('.transitplanetradius').html((Math.round(planet.radius/100000)*100)+" km");
	
				//get the top offset of the target anchor
				var target_offset = $("#relativesizes").offset();
				var target_top = target_offset.top;
	
				// Correct animation to only go as far as necessary so we don't 
				// try to go beyond the bottom of the page
				tall_win = $(window).height();
				tall_doc = $(document).height();
				t = target_top;
				if(tall_doc-target_top < tall_win) t = tall_doc - tall_win;
				
				$('#nextstep').removeClass('fancybtndisable');
				//goto that anchor by setting the body scroll top to anchor top
//				if(nscroll > 0){
//					$('html, body').animate({scrollTop:t}, 1500);
//					nscroll--;
//				}
	
			}else{
				stop();
			}
		}
		function stop(){
			$('#relativesizes').hide();
			if(typeof planet.svg.stop == "function") planet.svg.stop();
			orbiting = false;
		}
		function orbit() {
			orbiting = true;
			planet.svg.animate({
				"50%": {cx: star.x+(planet.a*metres2px), easing: "<>", callback: function () { planet.svg.toBack(); }},
				"100%": {cx: star.x-(planet.a*metres2px), easing: "<>", callback: function () { planet.svg.toFront(); orbit(); } }
			}, 20000);
		}
		function check (){
			vals = [];
			nodata = true;
			$('#calibrator_list input[type=checkbox]').each(function(){
				lcurve.used[$(this).val()] = ($(this).filter(":checked").length > 0) ? true : false;
				if(lcurve.used[$(this).val()]) nodata = false;
			});
			lcurve.update()
			if(nodata) bubblePopup({id:'message',el:$('#mainplot'),style:'warning',fade:2000,dismiss:true,align:"center",w:200,animate:true,html:'You have no calibrators selected. It will be impossible to calibrate your data! Please select some from the list below.'});
		}
		$('#calibrator_list input[type=checkbox]').bind('change',function(){
			check();
		});
		
		extra = "";
		{% if messages %}extra = $('#message').html(){% endif %}
//		bubblePopup({id:'message',el:$('#mainplot'),align:"center",w:200,animate:true,fade:3500,dismiss:true,html:'Use your mouse to select the region of the lightcurve which corresponds to the dip in brightness - the transit.'+extra})
		addHelpHint($('#mainplot'),'Use your mouse to select the region of the lightcurve which corresponds to the dip in brightness - the transit.');
	
	//	{% if messages %} bubblePopup({id:'message',el:$('#mainplot'),fade:2000,dismiss:true,align:"center",w:200,animate:true,html:'<ul class="messages">{% for message in messages %}{%ifchanged%}<li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>{%endifchanged%}{% endfor %}</ul>'});{% endif %}
	{% else %}
	{% endif %}
	})
	// -->
	</script>
{% endblock %}

{% block main-content %}
	<div class="page stackedpaper">
					{% if messages %}<div id="message">					
						<ul class="messages">
{% for message in messages %}{%ifchanged%}		<li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message|safe }}</li>{%endifchanged%}{% endfor %}
						</ul>
					</div>{% endif %}

{% if numsuper %}
		<h1>Step 3: Final Lightcurve for <a href="{% url agentex.views.infoview event.name %}" class="objectspecific">{{event.title}}</a></h1>
{% else %}
		<h1>No combined result for <a href="{% url agentex.views.infoview event.name %}" class="objectspecific">{{event.title}}</a> yet</h1>
{%endif%}
{% if user.is_authenticated %}
<!--
		<ol class="breadcrumb">
			<li><a href="{%url my-graph event.name%}"><img src="{{ MEDIA_URL }}images/graph_my.png" alt="My" title="View my measurements as a lightcurve" />Step 1: My measurements</a></li>
			<li><a href="{%url average-graph event.name%}"><img src="{{ MEDIA_URL }}images/graph_ave.png" alt="Classify" title="Classify your lightcurves" />Step 2: Classify lightcurves</a></li>
			<li class="active"><a href="{%url super-graph event.name%}"><img src="{{ MEDIA_URL }}images/graph_super.png" alt="Final" title="Final lightcurve" />Step 3: Final lightcurve</a></li>
		</ol>
-->
		<p class="breadcrumb"></p>
		<div id="mylink" style="display:none;"><a href="{%url my-graph event.name%}"><img src="{{ MEDIA_URL }}images/graph_my.png" alt="My" title="View my measurements as a lightcurve" /></a></div>
		<div id="avlink" style="display:none;"><a href="{%url average-graph event.name%}"><img src="{{ MEDIA_URL }}images/graph_ave.png" alt="Classify" title="Classify your lightcurves" /></a></div>
		<div id="sulink" class="tabactive" style="display:none;"><a href="{%url super-graph event.name%}"><img src="{{ MEDIA_URL }}images/graph_super.png" alt="Final" title="Final lightcurve" /></a></div>
{% else %}
		<p class="breadcrumb">You can contribute measurements to this lightcurve after <a href="{% url register %}?next={{ request.path }}">creating an account.</a> If you already have an account <a href="{% url django.contrib.auth.views.login %}?next={{ request.path }}">log in</a></p>
{% endif %}


{% if numsuper %}
		<div id="relativesizes" class="accessible">
			<br />
			<h2>Relative sizes</h2>
			<p>This cartoon shows the relative sizes of the star, planet and orbit based on the transit you've identified. It assumes that we are seeing <span class="objectspecific">{{event.title}}</span>'s orbit edge on.</h2>
			<div id="planetillustration"></div>
			<div id="planetcomparison"></div>
			<div id="planetillustration"></div>
			<div id="planetcalculation">
				<h2>How we worked this out</h2>
				<p>The orbital period for <span class="objectspecific">{{event.title}}</span> is known to be <span class="objectspecific transitperiod">{{ target.period }} days</span>. Through either the star's <a href="http://en.wikipedia.org/wiki/Stellar_classification">stellar type</a> or radial velocity measurements, we can infer a mass for the star of <span class="objectspecific">{{ target.mass }}</span> times that of the Sun. With <a href="http://en.wikipedia.org/wiki/Kepler%27s_laws_of_planetary_motion#Third_law">Kepler's third law of planetary motion</a> we can then calculate the orbital radius to be about <span class="objectspecific transitorbit"></span> (<span class="objectspecific transitorbitau"></span>).</p>
				<p>From the graph we estimate the transit to take <span class="transitlength objectspecific"></span> (we will call this <em>t<sub>trans</sub></em>) with a dip in brightness of <span class="transitdip objectspecific"></span>. The dip in brightness is related to the relative sizes of planet and star - the bigger the planet, compared to the star, the bigger the dip in brightness when it passes in front. Your measurements suggest the planet has a diameter roughly <span class="transitscale objectspecific"></span> times that of the host star. The duration of a transit is related to the orbital period <em>P</em>, the star's radius <em>R&lowast;</em>, the orbital radius <em>a</em> and the inclination of the orbit <em>i</em>. These are all related by the formula:</p>
				<table summary="Properties of the transiting system based on your measurement" class="borderless" style="border:0px;font-size: 1.2em; font-family: times, serif;"><tr>
					<td width="50%"></td>
					<td nowrap style="vertical-align:middle;"><i>t<sub>trans</sub></i> &nbsp;=</td>
					<td nowrap style="align:center;vertical-align:middle;">&nbsp; <i>P</i> &nbsp;<hr style="margin:0px;">&nbsp; <i>&pi;</i> &nbsp;</td>
					<td nowrap style="vertical-align:bottom;padding:0px;"><span style="font-size:3.5em;">&radic;</span></td>
					<td nowrap style="vertical-align:middle;border-top:2px solid black;padding:0px;">&nbsp;<span style="font-size:3em;">(<sup style="font-size:0.3em;"></sup></span></td>
					<td nowrap style="text-align:center;vertical-align:middle;border-top:2px solid black;padding:0px;">&nbsp; <i>R&lowast;</i> &nbsp;<hr style="margin:0px;">&nbsp; <i>a</i> &nbsp;</td>
					<td nowrap style="vertical-align:middle;border-top:2px solid black;padding:0px;"><span style="font-size:3em;">)<sup style="font-size:0.3em;">2</sup></span></td>
					<td nowrap style="vertical-align:middle;border-top:2px solid black;">&nbsp;&minus;&nbsp;<i>cos<sup>2</sup>&nbsp;(i)</i></td>
					<td width="50%"></td>
				</tr></table>
				<p>If we assume an edge-on orbit, like in the cartoon above, the inclination (<span style="font-family: times, serif;font-style:italic">i</span>) is zero and this becomes the more straightforward:</p>				
				<table class="borderless" style="border:0px!important;font-size: 1.2em; font-family: times, serif;"><tr>
					<td width="50%"></td>
					<td nowrap style="vertical-align:middle;"><i>t<sub>trans</sub></i> &nbsp;=</td>
					<td nowrap style="text-align:center;vertical-align:middle;">&nbsp; <i>P&nbsp;R&lowast;</i> &nbsp;<hr style="margin:0px;">&nbsp; <i>&pi;&nbsp;a</i> &nbsp;</td>
					<td width="50%"></td>
				</tr></table>
				<p>Using all the values we've measured, calculated or inferred the planet is then estimated to have a radius of <span class="objectspecific transitplanetradius"></span>.</p>
			</div>
			<div id="planetdetails"></div>
		</div>
		<p class="accessible">Without Javascript enabled we can't show you a lightcurve but you could create your own lightcurve using the data in the table below. You can also provide us with information about which calibrators are not variable by checking the boxes below.</p>

		<div style="text-align:right;">
			<a href="{% url agentex.views.target %}" class="fancybtn" id="nextstep">Next planet<span class="arrow">&nbsp;</span></a> 
		</div>

		<div style="max-width:900px;overflow:auto;">
		<table class="accessible" id="datatable" summary="The data used to make the final lightcurve">
			<tr><th>Observation date</th><th>Relative brightness</th><th>Estimated uncertainty</th></tr>
	{% for line in data %}
			<tr><td><a href="{% url agentex.views.addvalue event.name %}?dataid={{line.id}}">{{line.date}}</a></td><td>{{line.data.mean|floatformat:3}}</td><td>{{line.data.std|floatformat:3}}</td></tr>
	{% endfor %}
		</table>
		</div>
		
		

{% else%}
		<p>Bad news! Not enough measurements have been made yet.</p>
		<p>Go and <a href="{% url agentex.views.addvalue event.name %}">make more measurements</a>, then <a href="{%url average-graph event.name%}">classify your results</a>.
		<p>It will make this page much more exciting!</p>
{%endif%}
	</div>
{% endblock %}
